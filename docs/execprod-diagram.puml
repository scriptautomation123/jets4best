@startuml ExecProcCmd_Complete_Flow
!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultFontSize 10
skinparam activity {
    BackgroundColor #E8F4FD
    BorderColor #1976D2
    FontColor #000000
}
skinparam note {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
}

title Complete Flow: ExecProcCmd Execution with Authentication & Database Connection

|#LightBlue|CLI Entry Point|
start
:User executes: exec-proc -u username -d database procedure;
note right: Entry Point

:ExecProcedureCmd.main(args);
:Create CommandLine with ExecProcedureCmd;
:Set exception handlers (ExecutionExceptionHandler, ParameterExceptionHandler);
:cmd.execute(args);

|#LightGreen|CLI Processing|
:ExecProcedureCmd.call();
:Validate required parameters (user, database);

if (Parameters valid?) then (no)
  :Return error code 1;
  stop
endif

|#LightCyan|Service Layer|
:ProcedureExecutionService.execute(request);
:Create ProcedureRequest with builder pattern;
note right: Builds request with type, database, user, procedure, input, output, vaultConfig

|#Yellow|Password Resolution|
:BaseDatabaseExecutionService.resolvePassword(request);
:Create PasswordRequest;
:PasswordResolver.resolvePassword(passwordRequest);

if (hasDirectVaultParams()?) then (yes)
  note left: Direct vault parameters provided
  :resolveWithDirectVaultParams();
  |#Orange|Vault Authentication|
  :VaultClient.fetchOraclePassword(\nvaultUrl, roleId, secretId, database, ait, user);
  :buildVaultBaseUrl(vaultBaseUrl);
  :authenticateToVault(fullVaultUrl, roleId, secretId);
  :POST /v1/auth/approle/login;
  :Extract client_token from response;
  :fetchOraclePasswordSync(fullVaultUrl, clientToken, dbName, ait, username);
  :GET /v1/secrets/database/oracle/static-creds/{dbName}-{ait}-{username};
  :Return Oracle password;
  |#Yellow|Password Resolution|
else (no)
  :resolveWithVaultLookup(request);
  :VaultClient.fetchOraclePassword(user, database);
  note right: Search vaults.yaml for user config
  
  if (vaultParams found?) then (yes)
    :getVaultParamsForUser(user, database);
    :Load vault config from vaults.yaml;
    :Extract role-id, secret-id, base-url, ait;
    |#Orange|Vault Authentication|
    :fetchOraclePassword(vaultBaseUrl, roleId, secretId, database, ait, user);
    :buildVaultBaseUrl(vaultBaseUrl);
    :authenticateToVault(fullVaultUrl, roleId, secretId);
    :POST /v1/auth/approle/login;
    :Extract client_token;
    :fetchOraclePasswordSync(fullVaultUrl, clientToken, dbName, ait, username);
    :GET /v1/secrets/database/oracle/static-creds/{dbName}-{ait}-{username};
    :Return Oracle password;
    |#Yellow|Password Resolution|
  else (no)
    :promptForPassword();
    note right: Manual password entry fallback
    :Read password from console;
  endif
endif

|#LightCyan|Connection Management|
:BaseDatabaseExecutionService.createConnection(request, password);
:DatabaseService.createConnection(type, database, user, password);
:ConnectionStringGenerator.createConnectionString(\ntype, database, user, password, null);

if (type == "oracle" && host == null?) then (yes)
  :OracleLdap.buildUrl();
note right: Build Oracle LDAP URL for production database
  :Load LDAP config from application.yaml;
  :Build URL: jdbc:oracle:thin@ldap://oid1puser.bankofamerica...);
else (no)
  :OracleJdbc.buildUrl() or H2Jdbc.buildUrl();
  note right: Build JDBC URL for direct connection
endif

:DriverManager.getConnection(connectionUrl, user, password);

|#LightBlue|Procedure Execution|
:ProcedureExecutionService.executeWithConnection(request, conn);
:DatabaseService.executeProcedure(conn, procedure, input, output);
:ProcedureExecutor.executeProcedureWithStrings(\nconn, procFullName, inputParams, outputParams);
  
|#Pink|Database Operations|
  :Parse procedure name and parameters;
:parseStringInputParams(inputParams);
:parseStringOutputParams(outputParams);
:buildCallString(procFullName, inputs.size(), outputs.size());
  :Create CallableStatement;
:Set input parameters (setParameter);
:Register output parameters (registerOutParameter);
:Execute stored procedure (call.execute());
:Extract output parameters (call.getObject());
  :Return result Map<String, Object>;
  
|#LightBlue|Result Processing|
:ExecutionResult.success(result);
:result.formatOutput(System.out);

  if (Single result?) then (yes)
    :Print single value to console;
  else (no)
    :Print key-value pairs to console;
endif

:Return success code 0;
stop

@enduml